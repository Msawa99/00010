import { type NextRequest, NextResponse } from "next/server"

// ููุชุงุญ OpenRouter ูุน OpenAI
const OPENROUTER_API_KEY = "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"
const OPENROUTER_URL = "https://openrouter.ai/api/v1/chat/completions"

// ูุงุนุฏุฉ ุจูุงูุงุช ุงูููุงุฏ ุงููุงููููุฉ ุงููุญุณูุฉ
const legalDatabase = {
  labor: {
    "ุณุงุนุงุช ุงูุนูู": {
      article: "ุงููุงุฏุฉ 97",
      content: "ูุง ูุฌูุฒ ุชุดุบูู ุงูุนุงูู ุฃูุซุฑ ูู ุซูุงูู ุณุงุนุงุช ูู ุงูููู ุงููุงุญุฏ ุฃู ุซูุงู ูุฃุฑุจุนูู ุณุงุนุฉ ูู ุงูุฃุณุจูุน",
      relatedArticles: ["ุงููุงุฏุฉ 98", "ุงููุงุฏุฉ 99"],
    },
    ุงูุฑุงุญุฉ: {
      article: "ุงููุงุฏุฉ 98",
      content: "ูุฌุจ ุฅุนุทุงุก ุงูุนุงูู ูุชุฑุฉ ุฑุงุญุฉ ูุง ุชูู ุนู ูุตู ุณุงุนุฉ ุฎูุงู ูุชุฑุฉ ุงูุนูู ุฅุฐุง ุฒุงุฏุช ุนู ุฎูุณ ุณุงุนุงุช ูุชุชุงููุฉ",
      relatedArticles: ["ุงููุงุฏุฉ 97", "ุงููุงุฏุฉ 100"],
    },
    "ุงูุนูู ุงูุฅุถุงูู": {
      article: "ุงููุงุฏุฉ 99",
      content:
        "ุฅุฐุง ุงูุชุถุช ุธุฑูู ุงูุนูู ุชุดุบูู ุงูุนุงูู ุณุงุนุงุช ุฅุถุงููุฉุ ูุฌุจ ุฃูุง ุชุฒูุฏ ุนูู ุซูุงุซ ุณุงุนุงุช ูู ุงููููุ ูุฃู ูุคุฏู ูู ุฃุฌุฑ ุฅุถุงูู ูุฏุฑู 150% ูู ุฃุฌุฑู ุงูุฃุณุงุณู",
      relatedArticles: ["ุงููุงุฏุฉ 97", "ุงููุงุฏุฉ 98"],
    },
    ุงูุฅุฌุงุฒุงุช: {
      article: "ุงููุงุฏุฉ 109",
      content: "ููุนุงูู ุงูุญู ูู ุฅุฌุงุฒุฉ ุณูููุฉ ูุฏููุนุฉ ุงูุฃุฌุฑ ูุง ุชูู ุนู 21 ูููุงู ุฅุฐุง ุฃูุถู ูู ุงูุฎุฏูุฉ ุณูุฉ ูุงููุฉ",
      relatedArticles: ["ุงููุงุฏุฉ 110", "ุงููุงุฏุฉ 111"],
    },
  },
  health: {
    "ุญููู ุงููุฑูุถ": {
      article: "ุงููุงุฏุฉ 5",
      content: "ูููุฑูุถ ุงูุญู ูู ุงูุญุตูู ุนูู ุงูุฑุนุงูุฉ ุงูุตุญูุฉ ุงูููุงุณุจุฉ ูุงูุนูุงุฌ ุงููุงุฒู",
      relatedArticles: ["ุงููุงุฏุฉ 6", "ุงููุงุฏุฉ 7"],
    },
    "ุงูุชุฃููู ุงูุตุญู": {
      article: "ุงููุงุฏุฉ 12",
      content: "ูุญู ูููุคูู ุนููู ุงูุญุตูู ุนูู ุงูุฎุฏูุงุช ุงูุตุญูุฉ ุงููุดูููุฉ ุจุงูุชุฃููู ุฏูู ุชุญูู ุฃู ุฑุณูู ุฅุถุงููุฉ",
      relatedArticles: ["ุงููุงุฏุฉ 13", "ุงููุงุฏุฉ 14"],
    },
  },
  traffic: {
    "ุฑุฎุตุฉ ุงูููุงุฏุฉ": {
      article: "ุงููุงุฏุฉ 15",
      content: "ูุดุชุฑุท ููุญุตูู ุนูู ุฑุฎุตุฉ ููุงุฏุฉ ุงููุฑูุจุงุช ุฃู ูููู ุทุงูุจ ุงูุฑุฎุตุฉ ูุฏ ุฃุชู ุงูุซุงููุฉ ุนุดุฑุฉ ูู ุนูุฑู",
      relatedArticles: ["ุงููุงุฏุฉ 16", "ุงููุงุฏุฉ 17"],
    },
  },
}

const officialLinks = {
  labor: [
    { title: "ูุฒุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ - ุชูุฏูู ุดููู", url: "https://www.hrsd.gov.sa/complaints" },
    { title: "ููุตุฉ ููู - ุญููู ุงูุนูุงู", url: "https://qiwa.sa" },
    { title: "ุงููุคุณุณุฉ ุงูุนุงูุฉ ููุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ", url: "https://www.gosi.gov.sa" },
  ],
  health: [
    {
      title: "ูุฒุงุฑุฉ ุงูุตุญุฉ - ุดูุงูู ุงููุฑุถู",
      url: "https://www.moh.gov.sa/Ministry/MediaCenter/Publications/Pages/Publications-2020-10-27-002.aspx",
    },
    { title: "ูุฌูุณ ุงูุถูุงู ุงูุตุญู", url: "https://www.cchi.gov.sa" },
    { title: "ููุตุฉ ุตุญุฉ - ุงูุดูุงูู", url: "https://seha.sa" },
  ],
  traffic: [
    { title: "ุฃุจุดุฑ - ุงูุฎุฏูุงุช ุงููุฑูุฑูุฉ", url: "https://www.absher.sa" },
    { title: "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูููุฑูุฑ", url: "https://www.moi.gov.sa/wps/portal/Home/sectors/publicsecurity/traffic" },
    { title: "ููุตุฉ ุชููููุง - ุงููุฎุงููุงุช", url: "https://ta.gov.sa" },
  ],
  civil: [
    { title: "ููุงูุฉ ุงูุฃุญูุงู ุงููุฏููุฉ", url: "https://www.my.gov.sa/wps/portal/snp/agencies/agencyDetails/AC002" },
    { title: "ุฃุจุดุฑ - ุงูุฃุญูุงู ุงููุฏููุฉ", url: "https://www.absher.sa" },
  ],
  consumer: [
    { title: "ูุฒุงุฑุฉ ุงูุชุฌุงุฑุฉ - ุญูุงูุฉ ุงููุณุชููู", url: "https://mc.gov.sa/ar/consumer" },
    { title: "ููุตุฉ ุจูุงุบ ุชุฌุงุฑู", url: "https://cci.gov.sa" },
  ],
}

export async function POST(request: NextRequest) {
  try {
    const { message } = await request.json()

    if (!message || message.trim().length === 0) {
      return NextResponse.json({
        response: "ูุฑุฌู ูุชุงุจุฉ ุณุคุงูู ููุญุตูู ุนูู ุงููุณุงุนุฏุฉ.",
        articles: [],
        links: [],
      })
    }

    // ุชุญููู ุงูุณุคุงู ูุชุญุฏูุฏ ุงููุทุงุน ูุงูููุถูุน
    const analysis = analyzeQuestion(message)

    // ุฅูุดุงุก ุงูุฑุฏ ุจุงุณุชุฎุฏุงู OpenRouter + OpenAI
    const aiResponse = await generateOpenAIResponse(message, analysis)

    const response = {
      response: aiResponse,
      articles: analysis.articles,
      links: analysis.links,
    }

    return NextResponse.json(response)
  } catch (error) {
    console.error("Error in chat API:", error)

    // ูู ุญุงูุฉ ุงูุฎุทุฃุ ุงุณุชุฎุฏู ุฑุฏ ูุญูู
    try {
      const { message } = await request.json()
      const analysis = analyzeQuestion(message)
      const localResponse = getDetailedLocalResponse(message, analysis)

      return NextResponse.json({
        response: localResponse,
        articles: analysis.articles,
        links: analysis.links,
      })
    } catch {
      return NextResponse.json({
        response: "ุนุฐุฑุงูุ ุญุฏุซ ุฎุทุฃ ูู ุงููุธุงู. ูุฑุฌู ุงููุญุงููุฉ ูุฑุฉ ุฃุฎุฑู.",
        articles: [],
        links: [],
      })
    }
  }
}

function analyzeQuestion(question: string) {
  const lowerQuestion = question.toLowerCase()
  let sector = "general"
  let articles: string[] = []
  let links: { title: string; url: string }[] = []

  // ุชุญููู ูุทุงุน ุงูุนูู
  if (
    lowerQuestion.includes("ุนูู") ||
    lowerQuestion.includes("ููุธู") ||
    lowerQuestion.includes("ุฑุงุชุจ") ||
    lowerQuestion.includes("ุณุงุนุฉ") ||
    lowerQuestion.includes("ุฏูุงู") ||
    lowerQuestion.includes("ุฅุฌุงุฒุฉ") ||
    lowerQuestion.includes("ุงุฌุงุฒุฉ")
  ) {
    sector = "labor"

    if (lowerQuestion.includes("ุณุงุนุฉ") || lowerQuestion.includes("ุฏูุงู")) {
      articles.push("ุงููุงุฏุฉ 97", "ุงููุงุฏุฉ 98")
    }
    if (lowerQuestion.includes("ุฅุถุงูู") || lowerQuestion.includes("ุงุถุงูู")) {
      articles.push("ุงููุงุฏุฉ 99")
    }
    if (lowerQuestion.includes("ุฅุฌุงุฒุฉ") || lowerQuestion.includes("ุงุฌุงุฒุฉ")) {
      articles.push("ุงููุงุฏุฉ 109")
    }

    links = officialLinks.labor || []
  }

  // ุชุญููู ุงููุทุงุน ุงูุตุญู
  else if (
    lowerQuestion.includes("ุตุญุฉ") ||
    lowerQuestion.includes("ูุฑูุถ") ||
    lowerQuestion.includes("ูุณุชุดูู") ||
    lowerQuestion.includes("ุทุจูุจ") ||
    lowerQuestion.includes("ุนูุงุฌ")
  ) {
    sector = "health"
    articles = ["ุงููุงุฏุฉ 5", "ุงููุงุฏุฉ 6"]

    if (lowerQuestion.includes("ุชุฃููู")) {
      articles.push("ุงููุงุฏุฉ 12")
    }

    links = officialLinks.health || []
  }

  // ุชุญููู ูุทุงุน ุงููุฑูุฑ
  else if (
    lowerQuestion.includes("ูุฑูุฑ") ||
    lowerQuestion.includes("ููุงุฏุฉ") ||
    lowerQuestion.includes("ูุฎุงููุฉ") ||
    lowerQuestion.includes("ุฑุฎุตุฉ") ||
    lowerQuestion.includes("ุณูุงุฑุฉ")
  ) {
    sector = "traffic"
    articles = ["ุงููุงุฏุฉ 15"]
    links = officialLinks.traffic || []
  }

  // ุชุญููู ุงูุฃุญูุงู ุงููุฏููุฉ
  else if (
    lowerQuestion.includes("ูููุฉ") ||
    lowerQuestion.includes("ุฌูุงุฒ") ||
    lowerQuestion.includes("ูููุงุฏ") ||
    lowerQuestion.includes("ุฒูุงุฌ") ||
    lowerQuestion.includes("ุทูุงู")
  ) {
    sector = "civil"
    links = officialLinks.civil || []
  }

  // ุชุญููู ุญูุงูุฉ ุงููุณุชููู
  else if (
    lowerQuestion.includes("ูุณุชููู") ||
    lowerQuestion.includes("ุดุฑุงุก") ||
    lowerQuestion.includes("ุถูุงู") ||
    lowerQuestion.includes("ูุชุฌุฑ") ||
    lowerQuestion.includes("ููุชุฌ")
  ) {
    sector = "consumer"
    links = officialLinks.consumer || []
  }

  return { sector, articles: [...new Set(articles)], links }
}

// ุฃุถู ูุฐู ุงูุฏุงูุฉ ุงูุฌุฏูุฏุฉ ุจุนุฏ ุฏุงูุฉ analyzeQuestion

function getOfficialComplaintLinks(sector: string) {
  const complaintLinks = {
    labor: [
      {
        title: "ูุฒุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ - ุชูุฏูู ุดููู ุนูุงููุฉ",
        url: "https://www.hrsd.gov.sa/ar/complaint",
        phone: "19911",
      },
      { title: "ููุตุฉ ููู - ุงูุดูุงูู ุงูุนูุงููุฉ", url: "https://qiwa.sa/ar/individual/complaints", phone: "920020301" },
      {
        title: "ุงููุคุณุณุฉ ุงูุนุงูุฉ ููุชุฃูููุงุช ุงูุงุฌุชูุงุนูุฉ",
        url: "https://www.gosi.gov.sa/ar/complaints",
        phone: "8001243344",
      },
      { title: "ููุชุจ ุงูุนูู - ุงูุดูุงูู ุงููุจุงุดุฑุฉ", url: "https://www.hrsd.gov.sa/ar/offices", phone: "19911" },
    ],
    health: [
      {
        title: "ูุฒุงุฑุฉ ุงูุตุญุฉ - ุดูุงูู ุงููุฑุถู",
        url: "https://www.moh.gov.sa/Ministry/MediaCenter/Publications/Pages/Publications-2020-10-27-002.aspx",
        phone: "937",
      },
      { title: "ูุฌูุณ ุงูุถูุงู ุงูุตุญู ุงูุชุนุงููู", url: "https://www.cchi.gov.sa/ar/complaints", phone: "920001937" },
      { title: "ููุตุฉ ุตุญุฉ - ุงูุดูุงูู ุงูุทุจูุฉ", url: "https://seha.sa", phone: "937" },
      { title: "ุงูููุฆุฉ ุงูุณุนูุฏูุฉ ููุชุฎุตุตุงุช ุงูุตุญูุฉ", url: "https://www.scfhs.org.sa/ar/complaints", phone: "920019393" },
    ],
    traffic: [
      {
        title: "ุฃุจุดุฑ - ุงูุงุนุชุฑุงุถ ุนูู ุงููุฎุงููุงุช",
        url: "https://www.absher.sa/wps/portal/individuals/IndividualsServices/!ut/p/z1/04_Sj9CPykssy0xPLMnMz0vMAfIjo8zi_QO8nQ0C_E2dDQz8_VxNDTxDPJ0N_I0MvE30w8EKDHAARwP9KGL041EQhd_4cP0oVBTkRhikOyoqAgDTJCNQ/dz/d5/L2dBISEvZ0FBIS9nQSEh/",
        phone: "989",
      },
      {
        title: "ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูููุฑูุฑ",
        url: "https://www.moi.gov.sa/wps/portal/Home/sectors/publicsecurity/traffic",
        phone: "989",
      },
      { title: "ููุตุฉ ุชููููุง - ุงููุฎุงููุงุช ุงููุฑูุฑูุฉ", url: "https://ta.gov.sa", phone: "937" },
      { title: "ุดุฑูุฉ ุชุทููุฑ ุงูููู", url: "https://www.transport.gov.sa/ar/complaints", phone: "8001166666" },
    ],
    civil: [
      {
        title: "ููุงูุฉ ุงูุฃุญูุงู ุงููุฏููุฉ - ุงูุดูุงูู",
        url: "https://www.my.gov.sa/wps/portal/snp/agencies/agencyDetails/AC002",
        phone: "920020405",
      },
      { title: "ุฃุจุดุฑ - ุฎุฏูุงุช ุงูุฃุญูุงู ุงููุฏููุฉ", url: "https://www.absher.sa", phone: "920020405" },
      { title: "ูุฒุงุฑุฉ ุงูุฏุงุฎููุฉ - ุงูุดูุงูู", url: "https://www.moi.gov.sa/wps/portal/Home/complaint", phone: "989" },
    ],
    consumer: [
      {
        title: "ูุฒุงุฑุฉ ุงูุชุฌุงุฑุฉ - ุญูุงูุฉ ุงููุณุชููู",
        url: "https://mc.gov.sa/ar/consumer/Pages/default.aspx",
        phone: "1900",
      },
      { title: "ููุตุฉ ุจูุงุบ ุชุฌุงุฑู", url: "https://cci.gov.sa/ar/complaints", phone: "1900" },
      {
        title: "ุงูููุฆุฉ ุงูุณุนูุฏูุฉ ููููุงุตูุงุช ูุงูููุงููุณ",
        url: "https://www.saso.gov.sa/ar/complaints",
        phone: "920000940",
      },
    ],
    general: [
      { title: "ุฏููุงู ุงููุธุงูู", url: "https://www.bog.gov.sa/ar/complaints", phone: "8001221000" },
      { title: "ููุฆุฉ ุญููู ุงูุฅูุณุงู", url: "https://www.hrc.gov.sa/ar/complaints", phone: "8001221111" },
      { title: "ุงูููุงุจุฉ ุงูุนุงูุฉ", url: "https://www.ppo.gov.sa/ar/complaints", phone: "8001221555" },
    ],
  }

  return complaintLinks[sector] || complaintLinks.general
}

// ุนุฏูู ุฏุงูุฉ generateOpenAIResponse ูุชุดูู ุงูุฑูุงุจุท ุงูุฑุณููุฉ

async function generateOpenAIResponse(question: string, analysis: any) {
  const officialLinks = getOfficialComplaintLinks(analysis.sector)

  const systemPrompt = `ุฃูุช ูุณุชุดุงุฑ ูุงูููู ุฑุณูู ูุชุฎุตุต ูู ุงูุฃูุธูุฉ ูุงูููุงููู ุงูุณุนูุฏูุฉ ูุงุณูู "ูุณุชุดุงุฑ ุงุนุฑู ุญูููู". ุฃูุช ุชูุฏู ุงุณุชุดุงุฑุงุช ูุงููููุฉ ุฑุณููุฉ ูููุซูุฉ.

## ูููุชู ุงูุฃุณุงุณูุฉ:
ุชูุฏูู ุงุณุชุดุงุฑุงุช ูุงููููุฉ ุฑุณููุฉ ูุฏูููุฉ ููููุงุทููู ูุงููููููู ูุน ุงูุงุณุชุดูุงุฏ ุจุงูููุงุฏ ุงููุธุงููุฉ ูุงูุฅุฑุดุงุฏ ููุฌูุงุช ุงูุฑุณููุฉ ุงููุฎุชุตุฉ.

## ููุงุนุฏ ุงูุงุณุชุดุงุฑุฉ ุงูุฑุณููุฉ:
1. **ุงูุทุงุจุน ุงูุฑุณูู**: ุงุณุชุฎุฏู ูุบุฉ ูุงููููุฉ ุฑุณููุฉ ูุฏูููุฉ
2. **ุงูุงุณุชุดูุงุฏ ุงูุฏููู**: ุงุฐูุฑ ุฑูู ุงููุงุฏุฉ ูุงููุธุงู ุงููุฑุฌุนู ุจุฏูุฉ
3. **ุงูุชูุซูู**: ูุฏู ูุฑุงุฌุน ูุงููููุฉ ููุซูุฉ
4. **ุงูุฅุฑุดุงุฏ ุงูุฑุณูู**: ูุฌู ุงูุณุงุฆู ููุฌูุงุช ุงูุฑุณููุฉ ุงููุฎุชุตุฉ
5. **ุงูุดููููุฉ**: ูุฏู ุงุณุชุดุงุฑุฉ ุดุงููุฉ ุชุบุทู ุฌููุน ุฌูุงูุจ ุงููุณุฃูุฉ
6. **ุงูุชุญุฐูุฑุงุช ุงููุงููููุฉ**: ุงุฐูุฑ ุงูุนูุงูุจ ุงููุงููููุฉ ูุงูููู ุงูุฒูููุฉ

## ุงููุฑุงุฌุน ุงููุงููููุฉ ุงูุฃุณุงุณูุฉ:

### ุงููุธุงู ุงูุฃุณุงุณู ููุญูู:
- ุงููุงุฏุฉ 26: ุงูุฏููุฉ ุชุญูู ุญููู ุงูุฅูุณุงู ููู ุงูุดุฑูุนุฉ ุงูุฅุณูุงููุฉ
- ุงููุงุฏุฉ 36: ุชููุฑ ุงูุฏููุฉ ุงูุฃูู ูุฌููุน ููุงุทูููุง ูุงููููููู
- ุงููุงุฏุฉ 46: ุงููุถุงุก ุณูุทุฉ ูุณุชููุฉ ููุง ุณูุทุงู ุนููู ูุบูุฑ ุฃุญูุงู ุงูุดุฑูุนุฉ

### ูุธุงู ุงูุนูู:
- ุงููุงุฏุฉ 97: ุณุงุนุงุช ุงูุนูู ุงูููููุฉ ูุงูุฃุณุจูุนูุฉ
- ุงููุงุฏุฉ 98: ูุชุฑุงุช ุงูุฑุงุญุฉ ุงูุฅุฌุจุงุฑูุฉ
- ุงููุงุฏุฉ 99: ุงูุนูู ุงูุฅุถุงูู ูุงูุฃุฌูุฑ
- ุงููุงุฏุฉ 74: ุญู ุงูุนุงูู ูู ุงูุฑุงุชุจ
- ุงููุงุฏุฉ 80: ุญูุงูุฉ ุงูุนุงูู ูู ุงููุตู ุงูุชุนุณูู

## ุชูุณูู ุงูุงุณุชุดุงุฑุฉ ุงูุฑุณููุฉ:
1. **ุนููุงู ุงูุงุณุชุดุงุฑุฉ**: ุญุฏุฏ ููุถูุน ุงูุงุณุชุดุงุฑุฉ
2. **ุงูุชูููู ุงููุงูููู**: ุญุฏุฏ ุงููุธุงู ุงููุทุจู
3. **ุงูููุงุฏ ุงููุธุงููุฉ**: ุงุฐูุฑ ุงูููุงุฏ ุฐุงุช ุงูุนูุงูุฉ
4. **ุงูุชุญููู ุงููุงูููู**: ุงุดุฑุญ ุงููุถุน ุงููุงูููู
5. **ุงูุญููู ูุงููุงุฌุจุงุช**: ุญุฏุฏ ุญููู ููุงุฌุจุงุช ูู ุทุฑู
6. **ุงูุฅุฌุฑุงุกุงุช ุงููุทููุจุฉ**: ุญุฏุฏ ุงูุฎุทูุงุช ุงูุนูููุฉ
7. **ุงูุฌูุงุช ุงููุฎุชุตุฉ**: ุงุฐูุฑ ุงูุฌูุงุช ุงูุฑุณููุฉ ููุดููู
8. **ุงูููู ุงูุฒูููุฉ**: ุงุฐูุฑ ุงูููู ุงููุงููููุฉ ุงููููุฉ
9. **ุงูุชูุตูุงุช**: ูุฏู ุชูุตูุงุช ุนูููุฉ

## ุงูุฌูุงุช ุงูุฑุณููุฉ ุงููุชุงุญุฉ ููุดููู:
${officialLinks.map((link) => `- ${link.title}: ${link.url} | ูุงุชู: ${link.phone}`).join("\n")}

## ูุซุงู ุนูู ุงูุงุณุชุดุงุฑุฉ ุงูุฑุณููุฉ:
"๐ **ุงุณุชุดุงุฑุฉ ูุงููููุฉ ุฑุณููุฉ**
**ุงูููุถูุน:** ูุฎุงููุฉ ุณุงุนุงุช ุงูุนูู
**ุงูุชูููู ุงููุงูููู:** ูููุงู ููุธุงู ุงูุนูู ุงูุณุนูุฏู
**ุงูููุงุฏ ุงููุธุงููุฉ:** ุงููุงุฏุฉ 97ุ 98ุ 99
**ุงูุชุญููู ุงููุงูููู:** [ุชุญููู ููุตู]
**ุงูุญููู:** [ุญููู ุงูุนุงูู]
**ุงูุฅุฌุฑุงุกุงุช:** [ุฎุทูุงุช ุงูุดููู]
**ุงูุฌูุงุช ุงููุฎุชุตุฉ:** [ูุงุฆูุฉ ุงูุฌูุงุช]"

ุงูุณุคุงู: ${question}`

  // ุจุงูู ุงูููุฏ ูุจูู ููุง ูู...
  try {
    const response = await fetch(OPENROUTER_URL, {
      method: "POST",
      headers: {
        Authorization: `Bearer ${OPENROUTER_API_KEY}`,
        "Content-Type": "application/json",
        "HTTP-Referer": "https://knowyourrights.sa",
        "X-Title": "Know Your Rights - AI Legal Assistant",
      },
      body: JSON.stringify({
        model: "openai/gpt-4o-mini",
        messages: [
          {
            role: "system",
            content: systemPrompt,
          },
          {
            role: "user",
            content: question,
          },
        ],
        temperature: 0.2, // ุฎูุถุช ุฃูุซุฑ ููุญุตูู ุนูู ุฅุฌุงุจุงุช ุฃูุซุฑ ุฑุณููุฉ ูุฏูุฉ
        max_tokens: 1500, // ุฒุฏุช ููุญุตูู ุนูู ุงุณุชุดุงุฑุงุช ุฃูุซุฑ ุชูุตููุงู
        top_p: 0.8,
        frequency_penalty: 0.3,
        presence_penalty: 0.1,
      }),
    })

    if (!response.ok) {
      console.error("OpenRouter API Error:", response.status, response.statusText)
      const errorText = await response.text()
      console.error("Error details:", errorText)
      return getDetailedLocalResponse(question, analysis)
    }

    const data = await response.json()

    if (data.choices && data.choices[0] && data.choices[0].message) {
      return data.choices[0].message.content
    } else {
      console.error("Unexpected API response structure:", data)
      return getDetailedLocalResponse(question, analysis)
    }
  } catch (error) {
    console.error("OpenRouter API Error:", error)
    return getDetailedLocalResponse(question, analysis)
  }
}

function getDetailedLocalResponse(question: string, analysis: any) {
  const lowerQuestion = question.toLowerCase()

  // ุฃุณุฆูุฉ ุงูุนูู - ุณุงุนุงุช ุงูุนูู
  if (lowerQuestion.includes("ุณุงุนุฉ") || lowerQuestion.includes("ุฏูุงู")) {
    if (lowerQuestion.includes("12") || lowerQuestion.includes("ูกูข")) {
      return `โ๏ธ **ุชูุจูู ููู: ุงูุนูู 12 ุณุงุนุฉ ููููุงู ูุฎุงูู ูููุธุงู!**

๐ **ุงููุงุฏุฉ 97 ูู ูุธุงู ุงูุนูู ุงูุณุนูุฏู:**
โข ุงูุญุฏ ุงูุฃูุตู ููุนูู: **8 ุณุงุนุงุช ููููุงู** ุฃู **48 ุณุงุนุฉ ุฃุณุจูุนูุงู**
โข ูููู ุฒูุงุฏุฉ ุงูุนูู ุฅูู 9 ุณุงุนุงุช ูู ุจุนุถ ุงูุญุงูุงุช ุงูุงุณุชุซูุงุฆูุฉ ููุท

๐ **ุงููุงุฏุฉ 98 - ูุชุฑุงุช ุงูุฑุงุญุฉ ุงูุฅุฌุจุงุฑูุฉ:**
โข ูุฌุจ ุฅุนุทุงุก ุฑุงุญุฉ **ูุตู ุณุงุนุฉ** ูู **5 ุณุงุนุงุช** ุนูู ูุชุชุงููุฉ
โข ูุชุฑุฉ ุงูุฑุงุญุฉ ูุง ุชุญุชุณุจ ูู ุณุงุนุงุช ุงูุนูู

๐ **ุงููุงุฏุฉ 99 - ุงูุนูู ุงูุฅุถุงูู:**
โข ุงูุญุฏ ุงูุฃูุตู: **3 ุณุงุนุงุช ุฅุถุงููุฉ ููููุงู**
โข ุงูุฃุฌุฑ ุงูุฅุถุงูู: **150%** ูู ุงูุฃุฌุฑ ุงูุฃุณุงุณู
โข ูุฌุจ ููุงููุฉ ุงูุนุงูู ุนูู ุงูุนูู ุงูุฅุถุงูู

๐๏ธ **ุญูููู ุงููุงููููุฉ:**
โข ููููู ุฑูุถ ุงูุนูู ุฃูุซุฑ ูู 8 ุณุงุนุงุช ูุงููููุงู
โข ูู ุงูุญู ูู ุงููุทุงูุจุฉ ุจุฃุฌุฑ ุฅุถุงูู ุนู ุฃู ุณุงุนุฉ ุฒุงุฆุฏุฉ
โข ููููู ุชูุฏูู ุดููู ุถุฏ ุตุงุญุจ ุงูุนูู

๐ **ููุดููู ูุงููุณุงุนุฏุฉ:**
โข ูุฒุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ: ููุตุฉ ููู
โข ุงูุฎุท ุงูุณุงุฎู: 19911
โข ููููู ุชูุฏูู ุงูุดููู ุฅููุชุฑูููุงู ุฏูู ุงููุดู ุนู ูููุชู`
    }

    return `โฐ **ุณุงุนุงุช ุงูุนูู ูููุงู ูููุธุงู ุงูุณุนูุฏู:**

๐ **ุงููุงุฏุฉ 97 - ุณุงุนุงุช ุงูุนูู ุงูุฃุณุงุณูุฉ:**
โข **8 ุณุงุนุงุช** ูุญุฏ ุฃูุตู ููููุงู
โข **48 ุณุงุนุฉ** ูุญุฏ ุฃูุตู ุฃุณุจูุนูุงู  
โข ูููู ุฒูุงุฏุฉ ุงูุนูู ุฅูู **9 ุณุงุนุงุช** ูู ุญุงูุงุช ุฎุงุตุฉ ูุญุฏุฏุฉ ุจุงููุธุงู

๐ **ุงููุงุฏุฉ 98 - ูุชุฑุงุช ุงูุฑุงุญุฉ ุงูุฅุฌุจุงุฑูุฉ:**
โข ุฑุงุญุฉ **ูุตู ุณุงุนุฉ** ูู **5 ุณุงุนุงุช** ุนูู ูุชุชุงููุฉ
โข ูุง ุชุญุชุณุจ ูุชุฑุฉ ุงูุฑุงุญุฉ ูู ุณุงุนุงุช ุงูุนูู
โข ูุฐู ุงูุฑุงุญุฉ **ุญู ุฅุฌุจุงุฑู** ูููุณ ุงุฎุชูุงุฑู

๐ **ุงููุงุฏุฉ 99 - ุงูุนูู ุงูุฅุถุงูู:**
โข ุญุฏ ุฃูุตู **3 ุณุงุนุงุช ุฅุถุงููุฉ** ููููุงู
โข ุฃุฌุฑ ุฅุถุงูู **150%** ูู ุงูุฃุฌุฑ ุงูุฃุณุงุณู
โข ูุชุทูุจ ููุงููุฉ ุงูุนุงูู

๐ก **ูุตุงุฆุญ ูููุฉ:**
โข ุงุญุชูุธ ุจุณุฌู ูุณุงุนุงุช ุนููู ุงูููููุฉ
โข ุงุทูุจ ุฅุซุจุงุช ูุชุงุจู ูุฃู ุนูู ุฅุถุงูู
โข ูุง ุชุชุฑุฏุฏ ูู ุงููุทุงูุจุฉ ุจุญูููู`
  }

  // ุฃุณุฆูุฉ ุงูุฅุฌุงุฒุงุช
  if (lowerQuestion.includes("ุฅุฌุงุฒุฉ") || lowerQuestion.includes("ุงุฌุงุฒุฉ")) {
    return `๐๏ธ **ุญููู ุงูุฅุฌุงุฒุงุช ูู ูุธุงู ุงูุนูู ุงูุณุนูุฏู:**

๐ **ุงููุงุฏุฉ 109 - ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ:**
โข **21 ููู** ูุญุฏ ุฃุฏูู ุจุนุฏ ุฅููุงู ุณูุฉ ูุงููุฉ ูู ุงูุนูู
โข **30 ููู** ููุนูุงู ุงูุฐูู ุฃูุถูุง 5 ุณููุงุช ุฃู ุฃูุซุฑ
โข ุงูุฅุฌุงุฒุฉ **ูุฏููุนุฉ ุงูุฃุฌุฑ** ูุงููุงู

๐ **ุฃููุงุน ุงูุฅุฌุงุฒุงุช ุงูุฃุฎุฑู:**
โข **ุฅุฌุงุฒุฉ ูุฑุถูุฉ:** ุญุณุจ ุงูุชูุฑูุฑ ุงูุทุจู
โข **ุฅุฌุงุฒุฉ ุฃูููุฉ:** 10 ุฃุณุงุจูุน ููููุธูุงุช
โข **ุฅุฌุงุฒุฉ ุญุฌ:** ูุฑุฉ ูุงุญุฏุฉ ุฎูุงู ูุชุฑุฉ ุงูุฎุฏูุฉ
โข **ุฅุฌุงุฒุฉ ููุงุฉ:** 3 ุฃูุงู ููุฃูุงุฑุจ ูู ุงูุฏุฑุฌุฉ ุงูุฃููู

๐ก **ุญูููู ูู ุงูุฅุฌุงุฒุฉ:**
โข ูุง ูููู ูุตุงุญุจ ุงูุนูู ููุน ุงูุฅุฌุงุฒุฉ ุงูุณูููุฉ
โข ูููู ุชุฃุฌูู ุงูุฅุฌุงุฒุฉ ุจููุงููุฉ ุงูุทุฑููู
โข ูุญู ูู ุงูุญุตูู ุนูู ุจุฏู ููุฏู ุนู ุงูุฅุฌุงุฒุฉ ุนูุฏ ุงูุชูุงุก ุงูุฎุฏูุฉ

๐ **ููุงุณุชูุณุงุฑ:** ูุฒุงุฑุฉ ุงูููุงุฑุฏ ุงูุจุดุฑูุฉ - ููุตุฉ ููู`
  }

  // ุฃุณุฆูุฉ ุงูุตุญุฉ
  if (lowerQuestion.includes("ูุฑูุถ") || lowerQuestion.includes("ุตุญุฉ") || lowerQuestion.includes("ูุณุชุดูู")) {
    return `๐ฅ **ุญููู ุงููุฑูุถ ูู ุงููุธุงู ุงูุตุญู ุงูุณุนูุฏู:**

๐ **ุงููุงุฏุฉ 5 - ุญู ุงูุฑุนุงูุฉ ุงูุตุญูุฉ:**
โข ุงูุญู ูู ุงูุญุตูู ุนูู **ุงูุฑุนุงูุฉ ุงูุตุญูุฉ ุงูููุงุณุจุฉ**
โข ุงูุนูุงุฌ ูููุงู ูููุนุงููุฑ ุงูุทุจูุฉ ุงููุนุชูุฏุฉ
โข ุนุฏู ุงูุชูููุฒ ูู ุชูุฏูู ุงูุฎุฏูุฉ

๐ **ุงููุงุฏุฉ 6 - ุญู ุงููุนุฑูุฉ ูุงููุนูููุงุช:**
โข ูุนุฑูุฉ **ุงุณู ุงูุทุจูุจ ุงููุนุงูุฌ** ููุคููุงุชู
โข ุงูุญุตูู ุนูู **ูุนูููุงุช ูุงููุฉ** ุนู ุงูุชุดุฎูุต
โข ูุนุฑูุฉ **ุฎุทุฉ ุงูุนูุงุฌ** ูุงููุฎุงุทุฑ ุงููุญุชููุฉ
โข ุงูุญู ูู **ุฑุฃู ุทุจู ุซุงูู**

๐ **ุงููุงุฏุฉ 7 - ุญู ุงูุฎุตูุตูุฉ ูุงููุฑุงูุฉ:**
โข **ุงูุฎุตูุตูุฉ ุงูุชุงูุฉ** ุฃุซูุงุก ุงููุญุต ูุงูุนูุงุฌ
โข **ุญูุงูุฉ ุงููุนูููุงุช ุงูุทุจูุฉ** ูู ุงูุฅูุดุงุก
โข ุงูุญู ูู **ุฑูุถ ุงูุนูุงุฌ** ุฃู ุฅุฌุฑุงุก ูุนูู
โข **ุงููุฑุงูุฉ ุงูุฅูุณุงููุฉ** ูู ุฌููุน ูุฑุงุญู ุงูุนูุงุฌ

๐ **ุญููู ุฅุถุงููุฉ:**
โข ุงูุญุตูู ุนูู ุงูุฃุฏููุฉ ุงููุทููุจุฉ
โข ุฎุฏูุงุช ุงูุทูุงุฑุฆ ุฏูู ุชุฃุฎูุฑ
โข ุชูุงุฑูุฑ ุทุจูุฉ ุนูุฏ ุงูุทูุจ

๐ **ููุดูุงูู ุงูุทุจูุฉ:**
โข ูุฒุงุฑุฉ ุงูุตุญุฉ: 937
โข ูุฌูุณ ุงูุถูุงู ุงูุตุญู
โข ููุตุฉ ุตุญุฉ ุงูุฅููุชุฑูููุฉ`
  }

  // ุฃุณุฆูุฉ ุงููุฑูุฑ
  if (lowerQuestion.includes("ูุฑูุฑ") || lowerQuestion.includes("ููุงุฏุฉ") || lowerQuestion.includes("ูุฎุงููุฉ")) {
    return `๐ **ููุงููู ุงููุฑูุฑ ูู ุงูููููุฉ ุงูุนุฑุจูุฉ ุงูุณุนูุฏูุฉ:**

๐ **ุงููุงุฏุฉ 15 - ุดุฑูุท ุงูุญุตูู ุนูู ุฑุฎุตุฉ ุงูููุงุฏุฉ:**
โข ุฅุชูุงู **18 ุณูุฉ** ูู ุงูุนูุฑ
โข ุงุฌุชูุงุฒ **ุงููุญุต ุงูุทุจู**
โข ุงุฌุชูุงุฒ **ุงูุงุฎุชุจุงุฑ ุงููุธุฑู** ู**ุงูุนููู**
โข ุฏูุน ุงูุฑุณูู ุงูููุฑุฑุฉ

๐ฆ **ุงููุฎุงููุงุช ุงูุดุงุฆุนุฉ ูุบุฑุงูุงุชูุง:**
โข **ุชุฌุงูุฒ ุงูุณุฑุนุฉ:** 150-1000 ุฑูุงู ุญุณุจ ุงููุฎุงููุฉ
โข **ุนุฏู ุฑุจุท ุญุฒุงู ุงูุฃูุงู:** 150 ุฑูุงู
โข **ุงุณุชุฎุฏุงู ุงููุงุชู:** 500 ุฑูุงู
โข **ุนุฏู ุงูุชููู ุนูุฏ ุงูุฅุดุงุฑุฉ ุงูุญูุฑุงุก:** 1000 ุฑูุงู

๐ฑ **ููุงุณุชูุณุงุฑ ุนู ุงููุฎุงููุงุช:**
โข **ููุตุฉ ุฃุจุดุฑ** - ุงูุฎุฏูุงุช ุงููุฑูุฑูุฉ
โข **ุชุทุจูู ุชููููุง** - ูุณู ุงููุฎุงููุงุช
โข **ูููุน ุงูุฅุฏุงุฑุฉ ุงูุนุงูุฉ ูููุฑูุฑ**

โ๏ธ **ุญูููู ูู ุงููุฎุงููุงุช:**
โข ููููู **ุงูุงุนุชุฑุงุถ** ุนูู ุงููุฎุงููุฉ ุฎูุงู **30 ูููุงู**
โข ุญู ุทูุจ **ูุฑุงุฌุนุฉ ุงููุฎุงููุฉ** ูุน ุงูุฃุฏูุฉ
โข ุฅููุงููุฉ **ุงูุชูุณูุท** ูููุฎุงููุงุช ุงููุจูุฑุฉ

๐ก **ูุตุงุฆุญ ูููุฉ:**
โข ุงุญุชูุธ ุจุตูุฑ ููุญุงุฏุซ ุฅู ูุฌุฏ
โข ุชุฃูุฏ ูู ุตุญุฉ ุจูุงูุงุชู ูู ุงููุธุงู
โข ุฑุงุฌุน ูุฎุงููุงุชู ุฏูุฑูุงู`
  }

  // ุฑุฏ ุนุงู ููุฃุณุฆูุฉ ุบูุฑ ุงููุญุฏุฏุฉ
  return `ูุฑุญุจุงู ุจู ูู "ุงุนุฑู ุญูููู" ๐

๐ค **ุฃูุง ููุง ูุชูุฏูู ุงูุงุณุชุดุงุฑุงุช ุงููุงููููุฉ ููุณุงุนุฏุชู ูู ููู ุญูููู ููุงุฌุจุงุชู ูููุงู ููุฃูุธูุฉ ุงูุณุนูุฏูุฉ**

๐ **ูููููู ูุณุงุนุฏุชู ูู ุงููุฌุงูุงุช ุงูุชุงููุฉ:**

๐ข **ูุทุงุน ุงูุนูู ูุงูููุงุฑุฏ ุงูุจุดุฑูุฉ:**
โข ุณุงุนุงุช ุงูุนูู ูุงูุฑุงุญุฉ (ุงูููุงุฏ 97-98)
โข ุงูุฑูุงุชุจ ูุงูุนูู ุงูุฅุถุงูู (ุงููุงุฏุฉ 99)
โข ุงูุฅุฌุงุฒุงุช ุงูุณูููุฉ ูุงููุฑุถูุฉ (ุงููุงุฏุฉ 109)
โข ุญููู ุฅููุงุก ุงูุฎุฏูุฉ

๐ฅ **ุงููุทุงุน ุงูุตุญู:**
โข ุญููู ุงููุฑุถู (ุงูููุงุฏ 5-7)
โข ุงูุชุฃููู ุงูุตุญู ูุงูุชุบุทูุฉ
โข ุงูุดูุงูู ุงูุทุจูุฉ ูุงูุฃุฎุทุงุก

๐ **ูุทุงุน ุงููุฑูุฑ ูุงูููู:**
โข ุฑุฎุต ุงูููุงุฏุฉ ูุงูุชุฌุฏูุฏ
โข ุงููุฎุงููุงุช ุงููุฑูุฑูุฉ ูุบุฑุงูุงุชูุง
โข ุงูุญูุงุฏุซ ูุงูุชุฃููู

๐ฅ **ุงูุฃุญูุงู ุงููุฏููุฉ:**
โข ุงููููุฉ ุงููุทููุฉ ูุฌูุงุฒุงุช ุงูุณูุฑ
โข ุดูุงุฏุงุช ุงููููุงุฏ ูุงูุฒูุงุฌ
โข ุงูุฅุฌุฑุงุกุงุช ุงูุฑุณููุฉ

๐ก๏ธ **ุญูุงูุฉ ุงููุณุชููู:**
โข ุญููู ุงููุดุชุฑูู ูุงูุถูุงูุงุช
โข ุงูุดูุงูู ุงูุชุฌุงุฑูุฉ
โข ุงูุชุฌุงุฑุฉ ุงูุฅููุชุฑูููุฉ

๐ก **ุงูุชุจ ุณุคุงูู ุจูุถูุญ ูุณุฃูุฏู ูู ุงุณุชุดุงุฑุฉ ููุตูุฉ ูุน ุงูููุงุฏ ุงููุธุงููุฉ ุฐุงุช ุงูุตูุฉ ูุฑูุงุจุท ุงูุฌูุงุช ุงููุฎุชุตุฉ.**

ูุซุงู: "ุฃุนูู 12 ุณุงุนุฉ ููููุงูุ ูู ูุฐุง ูุงููููุ"`
}
